# SpotJAX

CLI tool for running JAX training jobs on Google Cloud Spot TPUs with automatic preemption recovery.

## Installation

```bash
pip install spotjax
```

## Quick Start

```bash
# First time: check and setup prerequisites
spotjax setup
spotjax setup --fix  # Auto-fix issues (create SSH keys, register with OS Login)

# Run a training script on a v4-8 TPU
spotjax run train.py --tpu v4-8 --zone us-central2-b --project my-gcp-project

# Generate checkpoint utilities for your project
spotjax init .
```

## Project Structure

SpotJAX expects a simple project layout:

```
my_project/
├── train.py          # Your training script (passed to CLI)
├── model.py          # Optional: any modules train.py imports
├── requirements.txt  # Optional: pip dependencies (auto-installed)
└── spotjax_utils.py  # Generated by: spotjax init .
```

When you run `spotjax run train.py`:
1. The entire `my_project/` folder is uploaded to TPU nodes at `/root/code/`
2. If `requirements.txt` exists, dependencies are installed via pip
3. Your script runs as `python train.py` on all nodes

## CLI Reference

### `spotjax run <script>`

Run a training script on Spot TPUs.

```bash
spotjax run train.py [OPTIONS]
```

| Option | Default | Description |
|--------|---------|-------------|
| `--tpu`, `-t` | `v4-8` | TPU type (v4-8, v4-32, v5p-16, etc.) |
| `--zone`, `-z` | `us-central2-b` | GCP zone |
| `--project`, `-p` | auto-detect | GCP project ID |
| `--bucket`, `-b` | `spotjax-{project}` | GCS bucket for checkpoints |
| `--name`, `-n` | timestamp | Job ID (e.g., `20260110-143022`) |
| `--code-dir`, `-c` | script's parent | Directory to upload |
| `--max-retries` | `5` | Retry attempts on preemption |
| `--node` | `0` | Node to stream logs from |

### `spotjax setup`

Check and setup SpotJAX prerequisites.

```bash
spotjax setup           # Check all prerequisites
spotjax setup --fix     # Auto-fix issues (create SSH keys, register with OS Login)
```

Checks:
- gcloud CLI installed and authenticated
- Application Default Credentials configured
- Default GCP project set
- SSH key exists
- SSH key registered with OS Login

### `spotjax init <directory>`

Generate `spotjax_utils.py` with checkpoint management utilities.

```bash
spotjax init .          # Current directory
spotjax init ./src      # Specific directory
spotjax init . --force  # Overwrite existing file
```

### `spotjax list-tpus`

List available TPU types across GCP zones.

```bash
spotjax list-tpus                   # Use auto-detected project
spotjax list-tpus --project my-gcp  # Specify project
```

Example output:
```
┏━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Zone           ┃ TPU Types                                           ┃
┡━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ us-central2-b  │ v4-8, v4-16, v4-32, v4-64, v4-128, v4-256, v4-512   │
│ us-east1-c     │ v5litepod-4, v5litepod-8, v5litepod-16              │
│ us-east5-a     │ v5p-8, v5p-16, v5p-32, v5p-64, v5p-128              │
│ europe-west4-b │ v5litepod-4, v5litepod-8                            │
└────────────────┴─────────────────────────────────────────────────────┘
```

Note: Actual availability depends on your project's quota and current demand.

## Environment Variables

SpotJAX injects these environment variables into your training script:

**Always set:**

| Variable | Example | Description |
|----------|---------|-------------|
| `SPOT_CHECKPOINT_DIR` | `gs://bucket/job-id/ckpt` | Where to save checkpoints |
| `SPOT_LOG_DIR` | `gs://bucket/job-id/logs` | Where to save logs |
| `SPOT_JOB_ID` | `20260110-143022` | Unique job identifier |
| `SPOT_IS_RESTART` | `true` / `false` | Whether this is a restart after preemption |

**Only set for multi-node (v4-16+):**

| Variable | Example | Description |
|----------|---------|-------------|
| `SPOT_WORKER_ID` | `0`, `1`, `2`, ... | This node's index |
| `SPOT_NUM_WORKERS` | `4` | Total number of nodes |
| `JAX_COORDINATOR_ADDRESS` | `10.0.0.1:1234` | For JAX distributed init |

For single-node (v4-8), JAX automatically uses all TPU chips - no distributed setup needed.

## Writing Your Training Script

Use the generated `spotjax_utils.py` to handle checkpoints:

```python
# train.py
from spotjax_utils import CheckpointManager, get_config

# Load config from environment
config = get_config()

# Setup checkpointing with preemption handling
ckpt = CheckpointManager(config.checkpoint_dir)
ckpt.setup_preemption_handler()  # Save on SIGTERM

# Restore or initialize state
state, start_step = ckpt.restore_or_init(initial_state, init_step=0)

# Training loop
for step in range(start_step, max_steps):
    state = train_step(state, batch)

    if step % 1000 == 0:
        ckpt.save(state, step)

ckpt.close()
```

For multi-node training (v4-16+), add `setup_distributed(config)` before training.

## How It Works

1. **Setup**: Create GCS bucket if it doesn't exist (for checkpoints/logs)
2. **Provision**: Creates a Spot TPU via Queued Resources API
3. **Connect**: SSH to all nodes in the TPU slice
4. **Upload**: rsync your code to `/root/code/` on all nodes
5. **Install**: Run `pip install -r requirements.txt` if present
6. **Run**: Execute your script on all nodes in parallel
7. **Monitor**: Stream logs, watch for checkpoint stalls
8. **Recover**: On preemption, cleanup and retry (up to `--max-retries`)
9. **Cleanup**: Delete TPU on completion or Ctrl+C

## Requirements

- Python 3.10+
- GCP project with TPU quota
- `gcloud` CLI installed ([install guide](https://cloud.google.com/sdk/docs/install))

Run `spotjax setup` to verify and configure all prerequisites automatically.
